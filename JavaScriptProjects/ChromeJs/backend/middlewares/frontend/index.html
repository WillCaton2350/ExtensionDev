<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Volume Control Extension</title>
</head>
<body>
    <h1>Volume Controller</h1>
    <h2>ðŸ”Š</h2>
    <button onclick="activate()" class="btn">Start</button>

    <script async src="https://docs.opencv.org/master/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <script src="middlewares/api.js"></script>

    <script>
        let cap, detector, volumeMin, volumeMax, currentVolume;

        function onOpenCvReady() {
            cap = new cv.VideoCapture();
            cap.open(0);
            cap.set(cv.CAP_PROP_FRAME_WIDTH, 640);
            cap.set(cv.CAP_PROP_FRAME_HEIGHT, 480);
            detector = new HandTrackingModule.HandDetector(1, 0.3);
            volumeMin = 0;
            volumeMax = 100;
            currentVolume = volumeMin;
            processVideo();
        }

        function changeVolume(volume) {
            const script = `osascript -e 'set volume output volume ${volume}'`;

            cv.utils.executeFile(script, (error, stdout, stderr) => {
                if (error) {
                    console.error(`Error changing volume: ${stderr}`);
                } else {
                    console.log(`Volume changed on the server: ${volume}`);
                }
            });
        }

        function processVideo() {
            let begin = Date.now();
            cap.read(img);
            let hands = detector.findHands(img, false);
            hands.forEach(hand => {
                let { x, y, width, height } = hand.bbox;
                cv.rectangle(img, new cv.Point(x, y), new cv.Point(x + width, y + height), [0, 255, 0, 255], 2);

                let length = Math.hypot(hand.lmList[8][0] - hand.lmList[4][0], hand.lmList[8][1] - hand.lmList[4][1]);
                if (length < 40) {
                    cv.circle(img, new cv.Point(hand.lmList[8][0], hand.lmList[8][1]), 10, [0, 255, 0, 255], cv.FILLED);
                }

                let targetVolume = cv.interp(length, [40, 200], [volumeMin, volumeMax]);
                let step = 58;

                if (currentVolume < targetVolume) {
                    currentVolume = Math.min(currentVolume + step, targetVolume);
                } else if (currentVolume > targetVolume) {
                    currentVolume = Math.max(currentVolume - step, targetVolume);
                }

                changeVolume(currentVolume);
                console.log(`Volume set to ${currentVolume}`);
            });

            cv.putText(img, `FPS: ${Math.round(1000 / (Date.now() - begin))}`, new cv.Point(50, 70), cv.FONT_HERSHEY_SIMPLEX, 1, [255, 0, 0, 255], 2);
            requestAnimationFrame(processVideo);
        }

        function activate() {
            console.log("Button clicked!");

            if (!cap || !cap.isOpened()) {
                cap = new cv.VideoCapture();
                cap.open(0);
                cap.set(cv.CAP_PROP_FRAME_WIDTH, 640);
                cap.set(cv.CAP_PROP_FRAME_HEIGHT, 480);
                setTimeout(() => {
                    processVideo();
                }, 1000); 
            }
        }
    </script>
</body>
</html>
